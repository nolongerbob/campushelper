# Изменение шага SSH на Stage для сверки схем БД (ЛР8)

В ЛР8 требуется **изменить шаг подключения и развертывания по SSH на Stage** так, чтобы после (или вместе с) развертыванием выполнялась **сверка схем БД** — приведение схемы на Stage в соответствие с чейнджлогом и при необходимости сравнение с Test.

---

## Что имеется в виду

- **Шаг «подключение и развертывание по SSH на Stage»** — в TeamCity уже есть шаг, который по SSH подключается к серверу Stage и выполняет развертывание (копирование артефактов, перезапуск сервиса и т.п.).
- **«Возможность сверки схем БД»** — на этом же шаге (или отдельным шагом) нужно выполнять **liquibase update** на Stage, чтобы схема БД на Stage совпадала с репозиторием; при необходимости — **liquibase diff** для сравнения с Test.

---

## Пошагово: что делать в TeamCity в этом шаге

Ниже — что именно сделать в интерфейсе TeamCity, чтобы в шаге подключения и развертывания по SSH на Stage появилась сверка схем БД.

### Шаг 1. Открыть настройки сборки

1. Зайди в TeamCity.
2. Выбери проект и **Build Configuration**, в которой настроен деплой на Stage (например, сборка по ветке **dev**).
3. Слева открой **Build Steps** (или «Шаги сборки»).

### Шаг 2. Найти шаг подключения по SSH на Stage

1. В списке шагов найди тот, который подключается к **Stage** по SSH и выполняет развертывание.
2. Обычно он называется вроде **«Deploy to Stage»**, **«SSH — Stage»**, **«Run remote script via SSH»** и т.п.
3. Нажми на него (или **Edit**), чтобы открыть настройки шага.

### Шаг 3. Добавить команды Liquibase в этот шаг

В настройках SSH-шага есть поле, где задаются команды, выполняемые **на удалённом сервере (Stage)** после подключения. Это может быть:

- **«Script»** / **«Custom script»**, или  
- **«Commands»** / **«Command»**, или  
- **«Deployment script»**  

в зависимости от типа шага (SSH Exec, Run remote script via SSH и т.д.).

**Что сделать:**

1. Не удаляй уже прописанные команды деплоя (копирование файлов, перезапуск сервиса и т.д.).
2. В **конец** списка команд (или в конец скрипта) добавь следующие строки:

```bash
# --- Сверка схемы БД на Stage (LР8) ---
cd /opt/campus_helper_liquibase
liquibase update
echo "Schema on Stage updated"
liquibase status
```

3. Путь `/opt/campus_helper_liquibase` замени на тот, где на сервере **Stage** реально лежит твой Liquibase-проект (каталог с `liquibase.properties` и `database/changelog/`). Если каталог другой — укажи его в `cd ...`.
4. Сохрани шаг (**Save**).

В результате при каждой сборке (например, по ветке dev) после деплоя приложения на Stage на том же сервере выполнится обновление схемы БД через Liquibase — это и есть «изменение шага для возможности сверки схем БД».

### Шаг 4. Проверить требования на сервере Stage

Чтобы команды выше отработали, на сервере **Stage** должно быть:

- Установлены **Java** и **Liquibase** (см. `LIQUIBASE_PROJECT_ON_VM.md`).
- В каталоге проекта (например, `/opt/campus_helper_liquibase`) лежат:
  - **liquibase.properties** с подключением к БД Stage (url, username, password для Stage-БД).
  - **database/changelog/** — актуальные файлы миграций (из репозитория или скопированные при деплое).

Если этого ещё нет — сначала настрой Liquibase на Stage по инструкции в `LIQUIBASE_PROJECT_ON_VM.md`.

---

## Вариант: вынести сверку в отдельный шаг

Если не хочешь трогать существующий SSH-шаг деплоя, можно добавить **новый шаг** после него:

1. В **Build Steps** нажми **Add build step**.
2. Выбери тип шага, который выполняет команды по SSH (например **SSH Exec** или **Run remote script via SSH**).
3. Укажи то же подключение к Stage (хост, ключ/логин), что и в шаге деплоя.
4. В поле команд укажи только:

```bash
cd /opt/campus_helper_liquibase
liquibase update
liquibase status
```

5. Сохрани. Тогда сначала выполнится старый шаг (деплой), затем новый шаг (сверка схемы).

---

## Сверка схем Test и Stage (liquibase diff)

Если в задании требуется именно **сравнить** схемы на Test и Stage (убедиться, что они совпадают), это делают через **liquibase diff**:

- На одной машине (например, на агенте TeamCity или на Stage) должны быть доступны подключения к обеим БД (Test и Stage).
- Вызов в общем виде:
  ```bash
  liquibase diff \
    --reference-url=jdbc:postgresql://test-server:5432/campus_helper \
    --reference-username=user --reference-password=secret
  ```
  При этом в `liquibase.properties` указан **url** (и логин/пароль) к **Stage**. Liquibase сравнивает Stage (текущий url) с reference (Test). Если отличий нет, diff ничего не меняет и завершается без ошибок; при отличиях покажет разницу.

Сценарий в шаге тогда может быть таким:

1. Деплой на Stage (как сейчас).
2. По SSH на Stage: `cd /opt/campus_helper_liquibase && liquibase update` — подтянуть схему на Stage по чейнджлогу.
3. При необходимости: запуск **liquibase diff** (с reference на Test), чтобы убедиться, что схемы Test и Stage совпадают.

---

## Чек-лист по шагу

- [ ] Открыл Build Configuration для деплоя на Stage (например, по ветке dev).
- [ ] Нашёл шаг «подключение и развертывание по SSH на Stage».
- [ ] Открыл настройки этого шага (Edit).
- [ ] В конец команд/скрипта добавил: `cd /opt/campus_helper_liquibase`, `liquibase update`, `liquibase status` (путь при необходимости заменил).
- [ ] Сохранил шаг (Save).
- [ ] На сервере Stage установлены Java и Liquibase, в каталоге проекта есть liquibase.properties (url на Stage-БД) и database/changelog/.

---

## Кратко

- **«Изменить шаг подключения и развертывания по SSH на Stage для возможности сверки схем БД»** = в шаге, который по SSH разворачивает приложение на Stage, добавить (или вынести в следующий SSH-шаг) выполнение на Stage:
  - `cd /путь/к/liquibase-проекту/на/stage`
  - `liquibase update`
  - при необходимости — `liquibase status` или `liquibase diff` с Test.
- На Stage в этом каталоге должен быть настроенный **liquibase.properties** с подключением к Stage-БД и актуальным чейнджлогом из репозитория.
