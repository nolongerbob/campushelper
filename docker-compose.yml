# Docker Compose для CI/CD в TeamCity
# Порт НЕ пробрасывается - в CI нам не нужен доступ к серверу извне
# Для локальной разработки используй arch/docker-compose.yml

services:
  server:
    build:
      context: ./server
      dockerfile: Dockerfile
    image: ${DOCKERHUB_USER:-campus}/campus-helper-server:latest
    # Порт НЕ пробрасываем в CI — контейнер только проверяется на запуск
    # Для локальной разработки используй arch/docker-compose.yml с портом 45454:45454
    environment:
      - DB_PATH=/app/data/campus_helper.db
    volumes:
      - db-data:/app/data
    restart: unless-stopped
    # Healthcheck для проверки что сервер запустился
    healthcheck:
      test: ["CMD", "timeout", "1", "bash", "-c", "echo > /dev/tcp/localhost/45454 || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 3
      start_period: 10s

volumes:
  db-data:
