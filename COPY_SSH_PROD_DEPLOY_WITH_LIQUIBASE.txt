========================================
ЛАБОРАТОРНАЯ РАБОТА 8 — SSH-ШАГ ДЕПЛОЯ НА PROD С LIQUIBASE
========================================

Полный скрипт для шага "Run remote script via SSH" / "SSH Exec" в TeamCity.
Этот шаг выполняется на сервере PROD по SSH.

========================================
ШАГ: Deploy to PROD (SSH Exec / Run remote script via SSH)
========================================

Runner type: SSH Exec (или Run remote script via SSH)
Step name: Deploy to PROD
Target: PROD server (SSH host, user, key)
Working directory: ПУСТО (команды выполняются на PROD)

Custom script / Commands:
──────────────────────────────────────

#!/bin/sh
set -e

echo "=== Деплой на PROD: остановка старого контейнера ==="
cd /opt/campus_helper_prod  # путь на Prod, где у тебя docker-compose.prod.yml
docker compose -f docker-compose.prod.yml down || true

echo "=== Pull нового образа из Docker Hub ==="
export DOCKER_IMAGE=danprog19/campus-helper-server:%build.number%  # или latest, или переменная TeamCity
docker pull "$DOCKER_IMAGE" || docker pull danprog19/campus-helper-server:latest

echo "=== Запуск нового контейнера ==="
docker compose -f docker-compose.prod.yml up -d

echo "=== Ожидание запуска контейнера ==="
sleep 5

echo "=== Сверка схемы БД на PROD через Liquibase (ЛР8) ==="
cd /opt/campus_helper_liquibase_prod  # каталог на Prod с liquibase.properties (url на Prod-БД) и database/changelog/
liquibase update
liquibase status

echo "=== Деплой на PROD завершён ==="

──────────────────────────────────────

Примечания:
- Путь `/opt/campus_helper_prod` — замени на реальный путь на Prod, где лежит docker-compose.prod.yml (или docker-compose.yml).
- Путь `/opt/campus_helper_liquibase_prod` — замени на путь, где на Prod лежит Liquibase-проект (liquibase.properties с url на Prod-БД, database/changelog/).
- Переменная `%build.number%` — это номер сборки TeamCity (если используешь теги образов). Если образы всегда latest — убери `:%build.number%`.
- На Prod должны быть установлены: Docker, docker-compose, Java, Liquibase (см. TEAMCITY_PROD_PIPELINE.md, Шаг 6).
- БД SQLite в volume на хосте Prod — поэтому liquibase update выполняется на хосте (не в контейнере).
- Для PROD рекомендуется ручной запуск сборки или по тегу (не автоматически при каждом коммите).

========================================
