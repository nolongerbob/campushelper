===========================================
СКОПИРУЙ ВСЁ ЭТО В TEAMCITY
===========================================

В TeamCity → Build Steps → Static Analysis: PVS-Studio
В поле "Custom script" вставь ВЕСЬ код ниже:

===========================================

set -e

echo "=== Установка зависимостей ==="
apt-get update -y
apt-get install -y apt-utils wget build-essential qt5-qmake qtbase5-dev cmake

echo "=== Установка PVS-Studio ==="
# Установка gpg если нет
apt-get install -y gnupg2 || apt-get install -y gnupg

# Современный способ добавления GPG ключа (без устаревшего apt-key)
mkdir -p /etc/apt/keyrings
wget -qO- https://cdn.pvs-studio.com/etc/pubkey.txt | gpg --dearmor > /etc/apt/keyrings/pvs-studio.gpg 2>/dev/null || {
  echo "⚠️  Не удалось добавить ключ PVS-Studio (возможно, сайт недоступен или ARM64 не поддерживается)"
  echo "Пропускаем PVS-Studio, используем только cppcheck"
  exit 0
}

echo "deb [signed-by=/etc/apt/keyrings/pvs-studio.gpg] https://cdn.pvs-studio.com/deb stable main" > /etc/apt/sources.list.d/viva64.list
apt-get update -y
apt-get install -y pvs-studio || {
  echo "⚠️  PVS-Studio не установился (возможно, не поддерживается на ARM64)"
  echo "Пропускаем PVS-Studio, используем только cppcheck"
  exit 0
}

echo "=== Добавление лицензии PVS-Studio ==="
pvs-studio-analyzer credentials PVS-Studio Free FREE-FREE-FREE-FREE

echo "=== Переход в папку сервера ==="
cd ./server

echo "=== Очистка старых файлов ==="
rm -f compile_commands.json moc* Makefile *.o *.pro strace_out pvs.log pvs*.tasks
rm -rf ./report

echo "=== Трассировка компиляции ==="
qmake -o Makefile server.pro
make clean
pvs-studio-analyzer trace -- make

echo "=== Запуск анализа PVS-Studio ==="
mkdir -p ./report
pvs-studio-analyzer analyze -l /root/.config/PVS-Studio/PVS-Studio.lic -o pvs.log --disableLicenseExpirationCheck || true

echo "=== Конвертация в HTML ==="
plog-converter -a GA:1,2 --renderTypes fullhtml -t tasklist -o ./report/ pvs.log || true

echo "=== Очистка ложных срабатываний ==="
if [ -f ./report/pvs.tasks ]; then
  sed "s|pvs-studio.com/en/docs/warnings/.*err.*Help.*|1|" ./report/pvs.tasks > ./report/pvs1.tasks 2>/dev/null || cp ./report/pvs.tasks ./report/pvs1.tasks
  sed "s|err Renew|1|" ./report/pvs1.tasks > ./report/pvs2.tasks 2>/dev/null || cp ./report/pvs1.tasks ./report/pvs2.tasks
else
  echo "⚠️  Отчет не создан"
  exit 0
fi

echo "=== Проверка на CRITICAL проблемы ==="
if grep -r 'err' ./report/pvs2.tasks 2>/dev/null; then
  echo "❌ CRITICAL security issues found!"
  exit 1
fi

echo "✅ PVS-Studio analysis completed successfully"

===========================================
КОНЕЦ КОДА ДЛЯ КОПИРОВАНИЯ
===========================================

ВАЖНО:
1. Working directory в TeamCity должен быть ПУСТЫМ
2. Скопируй весь код выше (от "set -e" до "completed successfully")
3. Вставь в поле "Custom script"
4. Сохрани шаг
5. Запусти сборку
