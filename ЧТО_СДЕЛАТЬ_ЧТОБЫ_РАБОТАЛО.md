# Что сделать, чтобы сверка схем БД на Stage работала

По пунктам. Сделай по порядку.

---

## 1. На сервере Stage (один раз)

Подключись по SSH к серверу Stage и выполни.

**1.1. Установи Java и Liquibase**

```bash
sudo apt-get update
sudo apt-get install -y openjdk-17-jre-headless
sudo mkdir -p /opt/liquibase
cd /tmp
sudo wget -q https://github.com/liquibase/liquibase/releases/download/v4.24.0/liquibase-4.24.0.tar.gz -O liquibase.tar.gz
sudo tar -xzf liquibase.tar.gz -C /opt/liquibase
sudo ln -sf /opt/liquibase/liquibase /usr/local/bin/liquibase 2>/dev/null || true
```

Проверка: `liquibase --version` (должен вывести версию).

**1.2. Создай каталог Liquibase-проекта на Stage**

```bash
sudo mkdir -p /opt/campus_helper_liquibase/database/changelog
sudo chown $USER:$USER /opt/campus_helper_liquibase
sudo chown -R $USER:$USER /opt/campus_helper_liquibase
```

**1.3. Положи в этот каталог файлы из репозитория**

С своей машины (из корня репозитория) скопируй на Stage в `/opt/campus_helper_liquibase/`:

- `liquibase.properties`
- `database/changelog/db.changelog-master.xml`
- `database/changelog/001_initial.sql`
- `database/changelog/002_add_settings.sql`

Пример с твоей машины (подставь свой хост и пользователя Stage):

```bash
cd /home/parallels/Documents
scp liquibase.properties user@stage-server:/opt/campus_helper_liquibase/
scp database/changelog/db.changelog-master.xml database/changelog/001_initial.sql database/changelog/002_add_settings.sql user@stage-server:/opt/campus_helper_liquibase/database/changelog/
```

**1.4. На Stage отредактируй liquibase.properties под Stage-БД**

На сервере Stage:

```bash
nano /opt/campus_helper_liquibase/liquibase.properties
```

В файле должны быть актуальные данные подключения к **БД на Stage**:

- Если БД SQLite на самом Stage, например:  
  `url=jdbc:sqlite:/opt/campus_helper/campus_helper.db`
- Если PostgreSQL на Stage:  
  `url=jdbc:postgresql://localhost:5432/campus_helper`  
  и раскомментируй/добавь `username=...` и `password=...`

Сохрани файл (Ctrl+O, Enter, Ctrl+X).

**1.5. Проверь с сервера Stage**

На Stage выполни:

```bash
cd /opt/campus_helper_liquibase
liquibase status
liquibase update
```

Ошибок быть не должно. После этого шаг 1 готов.

---

## 2. В TeamCity — создай SSH-шаг деплоя на Stage с Liquibase

В той сборке, которая деплоит на Stage (например, по ветке dev):

1. Открой **Build Steps** → **Add build step**.
2. Runner type: **SSH Exec** или **Run remote script via SSH**.
3. Step name: **Deploy to Stage**.
4. Настрой подключение к Stage (SSH host, user, key).
5. В поле **Script** / **Commands** вставь **весь скрипт ниже**:

```bash
#!/bin/sh
set -e

echo "=== Деплой на Stage: остановка старого контейнера ==="
cd /opt/campus_helper_stage  # путь, где у тебя docker-compose.stage.yml
docker compose -f docker-compose.stage.yml down || true

echo "=== Pull нового образа из Docker Hub ==="
export DOCKER_IMAGE=danprog19/campus-helper-server:%build.number%  # или latest
docker pull "$DOCKER_IMAGE" || docker pull danprog19/campus-helper-server:latest

echo "=== Запуск нового контейнера ==="
docker compose -f docker-compose.stage.yml up -d

echo "=== Ожидание запуска контейнера ==="
sleep 5

echo "=== Сверка схемы БД на Stage через Liquibase (ЛР8) ==="
cd /opt/campus_helper_liquibase  # каталог с liquibase.properties
liquibase update
liquibase status

echo "=== Деплой завершён ==="
```

6. Замени пути:
   - `/opt/campus_helper_stage` → путь на Stage, где лежит `docker-compose.stage.yml`.
   - `/opt/campus_helper_liquibase` → путь на Stage, где лежит Liquibase-проект.
   - `danprog19/campus-helper-server` → твой Docker Hub репозиторий (если другой).
   - `%build.number%` → если используешь теги образов по номеру сборки, иначе убери `:%build.number%` или замени на `latest`.
7. Сохрани шаг (**Save**).

**Полный скрипт также в файле:** `COPY_SSH_STAGE_DEPLOY_WITH_LIQUIBASE.txt`

---

## 3. Деплой должен обновлять файлы Liquibase на Stage (если менялся чейнджлог)

Чтобы на Stage всегда были актуальные миграции из репо, при деплое нужно копировать на Stage в `/opt/campus_helper_liquibase/` те же файлы, что в п. 1.3 (или клонировать/подтягивать репозиторий в этот каталог). Тогда перед командами из п. 2 в SSH-шаге можно добавить копирование артефактов (например, из сборки) в `/opt/campus_helper_liquibase/` и `database/changelog/`. Если деплой уже копирует туда файлы из репо — ничего менять не надо.

---

## Краткий чек-лист

- [ ] На Stage установлены Java и Liquibase.
- [ ] На Stage есть каталог `/opt/campus_helper_liquibase` с подкаталогом `database/changelog`.
- [ ] В нём лежат: `liquibase.properties`, `database/changelog/db.changelog-master.xml`, `001_initial.sql`, `002_add_settings.sql`.
- [ ] В `liquibase.properties` на Stage указан url (и при необходимости username/password) к БД Stage.
- [ ] С сервера Stage команды `cd /opt/campus_helper_liquibase && liquibase update` выполняются без ошибок.
- [ ] В SSH-шаге TeamCity в конец скрипта добавлены: `cd /opt/campus_helper_liquibase`, `liquibase update`, `liquibase status`.
- [ ] Шаг сохранён.

После этого при каждой сборке с деплоем на Stage будет выполняться сверка схемы БД (liquibase update).
