========================================
PVS-STUDIO –î–õ–Ø ARM64 (—á–µ—Ä–µ–∑ Docker x86_64)
========================================

‚ö†Ô∏è –í–ê–ñ–ù–û: –ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫ –∑–∞–π–º–µ—Ç 10-15 –º–∏–Ω—É—Ç (—Å–±–æ—Ä–∫–∞ Docker –æ–±—Ä–∞–∑–∞)
‚ö†Ô∏è –ü–æ—Å–ª–µ–¥—É—é—â–∏–µ –∑–∞–ø—É—Å–∫–∏: 5-10 –º–∏–Ω—É—Ç (—ç–º—É–ª—è—Ü–∏—è x86_64 –Ω–∞ ARM64)

========================================
–®–ê–ì –í TEAMCITY: PVS-Studio (Docker)
========================================

Runner type: Command Line
Step name: Static Analysis: PVS-Studio (Docker x86_64)
Run: Custom script
Working directory: –ü–£–°–¢–û

Custom script:
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

#!/bin/bash
# –ó–∞–ø—É—Å–∫ PVS-Studio —á–µ—Ä–µ–∑ Docker x86_64 –¥–ª—è ARM64 —Ö–æ—Å—Ç–æ–≤

set -e

echo "=== –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã ==="
ARCH=$(uname -m)
echo "–¢–µ–∫—É—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞: $ARCH"

if [ "$ARCH" != "aarch64" ] && [ "$ARCH" != "arm64" ]; then
  echo "‚úÖ –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ x86_64, –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–∞—Ç–∏–≤–Ω—ã–π PVS-Studio"
  echo "‚ö†Ô∏è  –î–ª—è x86_64 –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ–±—ã—á–Ω—ã–π pvs-studio.sh —Å–∫—Ä–∏–ø—Ç"
  exit 0
fi

echo "‚ö†Ô∏è  ARM64 –æ–±–Ω–∞—Ä—É–∂–µ–Ω, –∑–∞–ø—É—Å–∫–∞–µ–º PVS-Studio —á–µ—Ä–µ–∑ Docker x86_64"
echo "‚ö†Ô∏è  –≠—Ç–æ –∑–∞–π–º–µ—Ç 5-10 –º–∏–Ω—É—Ç –∏–∑-–∑–∞ —ç–º—É–ª—è—Ü–∏–∏!"

echo "=== –£—Å—Ç–∞–Ω–æ–≤–∫–∞ qemu –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ Docker buildx ==="
apt-get update -y
apt-get install -y qemu-user-static binfmt-support

echo "=== –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è QEMU –¥–ª—è —ç–º—É–ª—è—Ü–∏–∏ x86_64 ==="
# –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º binfmt –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —ç–º—É–ª—è—Ü–∏–∏
update-binfmts --enable qemu-x86_64 || true
docker run --rm --privileged multiarch/qemu-user-static --reset -p yes || true

echo "=== –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Docker buildx ==="
docker buildx create --name multiplatform --use 2>/dev/null || docker buildx use multiplatform || true
docker buildx inspect --bootstrap || true

echo "=== –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –æ–±—Ä–∞–∑–∞ PVS-Studio ==="
if ! docker image inspect pvs-studio-x86:latest >/dev/null 2>&1; then
  echo "=== –°–æ–∑–¥–∞–Ω–∏–µ Dockerfile –¥–ª—è PVS-Studio ==="
  cat > /tmp/Dockerfile.pvs <<'DOCKERFILE_END'
FROM ubuntu:22.04

ENV DEBIAN_FRONTEND=noninteractive

RUN apt-get update && \
    apt-get install -y wget gnupg2 build-essential qt5-qmake qtbase5-dev cmake && \
    mkdir -p /etc/apt/keyrings && \
    wget -qO- https://cdn.pvs-studio.com/etc/pubkey.txt | gpg --dearmor > /etc/apt/keyrings/pvs-studio.gpg && \
    echo "deb [signed-by=/etc/apt/keyrings/pvs-studio.gpg] https://cdn.pvs-studio.com/deb stable main" > /etc/apt/sources.list.d/viva64.list && \
    apt-get update && \
    apt-get install -y pvs-studio && \
    rm -rf /var/lib/apt/lists/*

WORKDIR /workspace
DOCKERFILE_END

  echo "=== –°–±–æ—Ä–∫–∞ Docker –æ–±—Ä–∞–∑–∞ —á–µ—Ä–µ–∑ buildx (–∑–∞–π–º–µ—Ç 10-15 –º–∏–Ω—É—Ç –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ) ==="
  docker buildx build --platform linux/amd64 --load -f /tmp/Dockerfile.pvs -t pvs-studio-x86:latest /tmp/
  echo "‚úÖ –û–±—Ä–∞–∑ —Å–æ–±—Ä–∞–Ω –∏ –∑–∞–∫–µ—à–∏—Ä–æ–≤–∞–Ω –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–∏—Ö –∑–∞–ø—É—Å–∫–æ–≤"
else
  echo "‚úÖ –û–±—Ä–∞–∑ pvs-studio-x86:latest —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–±–æ—Ä–∫—É"
fi

echo "=== –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π ==="
mkdir -p ./server/report

echo "=== –ó–∞–ø—É—Å–∫ –∞–Ω–∞–ª–∏–∑–∞ PVS-Studio –≤ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ ==="
# –ò—Å–ø–æ–ª—å–∑—É–µ–º qemu-x86_64 –¥–ª—è —ç–º—É–ª—è—Ü–∏–∏
docker run --rm \
  --platform linux/amd64 \
  -v "$(pwd):/workspace" \
  -w /workspace/server \
  pvs-studio-x86:latest \
  bash -c "
    set -e
    echo '=== –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ª–∏—Ü–µ–Ω–∑–∏–∏ PVS-Studio ==='
    pvs-studio-analyzer credentials daniel.kojemyakin@icloud.com Y0G0-6XBZ-2R81-C605
    echo '‚úÖ –õ–∏—Ü–µ–Ω–∑–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∞'
    
    echo '=== –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö —Ñ–∞–π–ª–æ–≤ ==='
    rm -f compile_commands.json moc* Makefile *.o strace_out pvs.log pvs*.tasks
    rm -rf ./report
    
    echo '=== –¢—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏ ==='
    qmake -o Makefile server.pro
    make clean
    pvs-studio-analyzer trace -- make
    
    echo '=== –ó–∞–ø—É—Å–∫ –∞–Ω–∞–ª–∏–∑–∞ PVS-Studio ==='
    mkdir -p ./report
    pvs-studio-analyzer analyze -l /root/.config/PVS-Studio/PVS-Studio.lic -o pvs.log --disableLicenseExpirationCheck || true
    
    echo '=== –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤ HTML ==='
    plog-converter -a GA:1,2 --renderTypes fullhtml -t tasklist -o ./report/ pvs.log || true
    
    echo '=== –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ ==='
    if [ -f ./report/pvs.tasks ]; then
      echo '‚úÖ HTML –æ—Ç—á–µ—Ç —Å–æ–∑–¥–∞–Ω'
    else
      echo '‚ö†Ô∏è  –û—Ç—á–µ—Ç –Ω–µ —Å–æ–∑–¥–∞–Ω'
      exit 0
    fi
  "

echo "=== –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã ==="
if [ -f ./server/report/pvs.tasks ]; then
  if grep -i 'error' ./server/report/pvs.tasks 2>/dev/null | grep -v 'pvs-studio.com' | grep -v 'Renew' | head -5; then
    echo "‚ö†Ô∏è  –ù–∞–π–¥–µ–Ω—ã –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã (—Å–º. HTML –æ—Ç—á–µ—Ç)"
    echo "–î–ª—è —Å—Ç—Ä–æ–≥–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ 'exit 1' –Ω–∏–∂–µ"
    # exit 1
  fi
fi

echo "‚úÖ PVS-Studio analysis completed successfully"
echo "üìä –û—Ç—á–µ—Ç: server/report/index.html"

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

Artifacts paths:
server/report/** => pvs-studio-report

========================================
–ù–ê–°–¢–†–û–ô–ö–ê REPORT TAB
========================================

Project Settings ‚Üí Report Tabs ‚Üí Create new report tab:

Tab title: PVS-Studio Report
Start page: pvs-studio-report/index.html

========================================
