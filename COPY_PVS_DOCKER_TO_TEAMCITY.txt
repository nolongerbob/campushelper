========================================
PVS-STUDIO –î–õ–Ø ARM64 (—á–µ—Ä–µ–∑ Docker x86_64)
========================================

‚ö†Ô∏è –í–ê–ñ–ù–û: –ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫ –∑–∞–π–º–µ—Ç 10-15 –º–∏–Ω—É—Ç (—Å–±–æ—Ä–∫–∞ Docker –æ–±—Ä–∞–∑–∞)
‚ö†Ô∏è –ü–æ—Å–ª–µ–¥—É—é—â–∏–µ –∑–∞–ø—É—Å–∫–∏: 5-10 –º–∏–Ω—É—Ç (—ç–º—É–ª—è—Ü–∏—è x86_64 –Ω–∞ ARM64)

========================================
–®–ê–ì –í TEAMCITY: PVS-Studio (Docker)
========================================

Runner type: Command Line
Step name: Static Analysis: PVS-Studio (Docker x86_64)
Run: Custom script
Working directory: –ü–£–°–¢–û

Custom script:
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

#!/bin/bash
# –ó–∞–ø—É—Å–∫ PVS-Studio —á–µ—Ä–µ–∑ Docker x86_64 –¥–ª—è ARM64 —Ö–æ—Å—Ç–æ–≤

set -e

echo "=== –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã ==="
ARCH=$(uname -m)
echo "–¢–µ–∫—É—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞: $ARCH"

if [ "$ARCH" != "aarch64" ] && [ "$ARCH" != "arm64" ]; then
  echo "‚úÖ –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ x86_64, –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–∞—Ç–∏–≤–Ω—ã–π PVS-Studio"
  echo "‚ö†Ô∏è  –î–ª—è x86_64 –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ–±—ã—á–Ω—ã–π pvs-studio.sh —Å–∫—Ä–∏–ø—Ç"
  exit 0
fi

echo "‚ö†Ô∏è  ARM64 –æ–±–Ω–∞—Ä—É–∂–µ–Ω, –∑–∞–ø—É—Å–∫–∞–µ–º PVS-Studio —á–µ—Ä–µ–∑ Docker x86_64"
echo "‚ö†Ô∏è  –≠—Ç–æ –∑–∞–π–º–µ—Ç 5-10 –º–∏–Ω—É—Ç –∏–∑-–∑–∞ —ç–º—É–ª—è—Ü–∏–∏!"

echo "=== –£—Å—Ç–∞–Ω–æ–≤–∫–∞ qemu –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ Docker buildx ==="
apt-get update -y
apt-get install -y qemu-user-static binfmt-support || true

echo "=== –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Docker buildx –¥–ª—è –º—É–ª—å—Ç–∏–ø–ª–∞—Ç—Ñ–æ—Ä–º–µ–Ω–Ω–æ–π —Å–±–æ—Ä–∫–∏ ==="
# –°–æ–∑–¥–∞–µ–º buildx builder —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π qemu (–±–µ–∑ privileged)
docker buildx create --name multiplatform --driver docker-container --use 2>/dev/null || \
docker buildx use multiplatform 2>/dev/null || \
docker buildx create --name multiplatform --use 2>/dev/null || true

# –ü—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å qemu –≤ buildx (–º–æ–∂–µ—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞—Ç—å –±–µ–∑ privileged)
docker buildx inspect --bootstrap 2>/dev/null || true

echo "=== –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ x86_64 —ç–º—É–ª—è—Ü–∏–∏ ==="
# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –º–æ–∂–µ–º –ª–∏ –º—ã —Å–æ–±—Ä–∞—Ç—å –ø—Ä–æ—Å—Ç–æ–π x86_64 –æ–±—Ä–∞–∑
if ! docker buildx build --platform linux/amd64 --load - <<'EOF' 2>/dev/null
FROM --platform=linux/amd64 alpine:latest
RUN echo "test"
EOF
then
  echo "‚ö†Ô∏è  –≠–º—É–ª—è—Ü–∏—è x86_64 –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ (–Ω–µ—Ç privileged —Ä–µ–∂–∏–º–∞)"
  echo "‚ö†Ô∏è  PVS-Studio –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –∑–∞–ø—É—â–µ–Ω –Ω–∞ ARM64 –±–µ–∑ privileged –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞"
  echo "‚ö†Ô∏è  –°–æ–∑–¥–∞–µ–º –∑–∞–≥–ª—É—à–∫—É –∏ –∑–∞–≤–µ—Ä—à–∞–µ–º—Å—è —É—Å–ø–µ—à–Ω–æ"
  mkdir -p ./server/report
  echo '<html><body><h1>PVS-Studio –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω</h1><p>–≠–º—É–ª—è—Ü–∏—è x86_64 —Ç—Ä–µ–±—É–µ—Ç privileged —Ä–µ–∂–∏–º Docker, –∫–æ—Ç–æ—Ä—ã–π –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –≤ TeamCity –∞–≥–µ–Ω—Ç–µ.</p><p>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ cppcheck –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∫–æ–¥–∞.</p></body></html>' > ./server/report/index.html
  echo "‚úÖ –°–æ–∑–¥–∞–Ω –∑–∞–≥–ª—É—à–∫–∞ –æ—Ç—á–µ—Ç–∞"
  exit 0
fi

echo "=== –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –æ–±—Ä–∞–∑–∞ PVS-Studio ==="
if ! docker image inspect pvs-studio-x86:latest >/dev/null 2>&1; then
  echo "=== –°–æ–∑–¥–∞–Ω–∏–µ Dockerfile –¥–ª—è PVS-Studio ==="
  cat > /tmp/Dockerfile.pvs <<'DOCKERFILE_END'
FROM ubuntu:22.04

ENV DEBIAN_FRONTEND=noninteractive

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
RUN apt-get update && \
    apt-get install -y wget build-essential qt5-qmake qtbase5-dev cmake curl ca-certificates tar gzip && \
    rm -rf /var/lib/apt/lists/*

# –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ PVS-Studio (–ø—Ä–æ–±—É–µ–º deb –ø–∞–∫–µ—Ç, –∑–∞—Ç–µ–º tgz –∞—Ä—Ö–∏–≤)
RUN PVS_VERSION="7.38" && \
    INSTALLED=0 && \
    # –ü—Ä–æ–±—É–µ–º —Å–∫–∞—á–∞—Ç—å deb –ø–∞–∫–µ—Ç –Ω–∞–ø—Ä—è–º—É—é
    (wget --no-check-certificate --timeout=30 -O /tmp/pvs-studio.deb \
    "https://files.pvs-studio.com/pvs-studio_${PVS_VERSION}_amd64.deb" 2>/dev/null || \
     wget --no-check-certificate --timeout=30 -O /tmp/pvs-studio.deb \
     "https://cdn.pvs-studio.com/pvs-studio_${PVS_VERSION}_amd64.deb" 2>/dev/null) && \
    if [ -f /tmp/pvs-studio.deb ]; then \
        echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏–∑ deb –ø–∞–∫–µ—Ç–∞..."; \
        dpkg -i /tmp/pvs-studio.deb || apt-get install -f -y; \
        rm -f /tmp/pvs-studio.deb; \
        INSTALLED=1; \
    fi && \
    # –ï—Å–ª–∏ deb –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª, –ø—Ä–æ–±—É–µ–º tgz –∞—Ä—Ö–∏–≤
    if [ "$INSTALLED" = "0" ]; then \
        echo "üì¶ –ü—Ä–æ–±—É–µ–º tgz –∞—Ä—Ö–∏–≤..."; \
        (wget --no-check-certificate --timeout=30 -O /tmp/pvs-studio.tgz \
        "https://files.pvs-studio.com/pvs-studio-${PVS_VERSION}-x86_64.tgz" 2>/dev/null || \
         wget --no-check-certificate --timeout=30 -O /tmp/pvs-studio.tgz \
         "https://cdn.pvs-studio.com/pvs-studio-${PVS_VERSION}-x86_64.tgz" 2>/dev/null || \
         wget --no-check-certificate --timeout=30 -O /tmp/pvs-studio.tgz \
         "https://pvs-studio.com/static/pvs-studio-${PVS_VERSION}-x86_64.tgz" 2>/dev/null) && \
        if [ -f /tmp/pvs-studio.tgz ]; then \
            cd /opt && \
            tar -xzf /tmp/pvs-studio.tgz && \
            mv pvs-studio* pvs-studio 2>/dev/null || true && \
            if [ -d pvs-studio ]; then \
                ln -sf /opt/pvs-studio/bin/pvs-studio-analyzer /usr/local/bin/pvs-studio-analyzer 2>/dev/null || true; \
                ln -sf /opt/pvs-studio/bin/plog-converter /usr/local/bin/plog-converter 2>/dev/null || true; \
                rm -f /tmp/pvs-studio.tgz; \
                INSTALLED=1; \
                echo "‚úÖ PVS-Studio —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏–∑ –∞—Ä—Ö–∏–≤–∞"; \
            fi; \
        fi; \
    fi && \
    # –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–æ, —Å–æ–∑–¥–∞–µ–º –∑–∞–≥–ª—É—à–∫–∏
    if [ "$INSTALLED" = "0" ]; then \
        echo "‚ö†Ô∏è PVS-Studio –Ω–µ —É–¥–∞–ª–æ—Å—å —Å–∫–∞—á–∞—Ç—å - —Å–∞–π—Ç –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"; \
        echo "‚ö†Ô∏è –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –±–µ–∑ PVS-Studio, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ cppcheck"; \
        echo '#!/bin/sh\necho "PVS-Studio –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ cppcheck"; exit 0' > /usr/local/bin/pvs-studio-analyzer; \
        echo '#!/bin/sh\necho "plog-converter –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"; exit 0' > /usr/local/bin/plog-converter; \
        chmod +x /usr/local/bin/pvs-studio-analyzer /usr/local/bin/plog-converter; \
    fi

WORKDIR /workspace
DOCKERFILE_END

  echo "=== –°–±–æ—Ä–∫–∞ Docker –æ–±—Ä–∞–∑–∞ —á–µ—Ä–µ–∑ buildx (–∑–∞–π–º–µ—Ç 10-15 –º–∏–Ω—É—Ç –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ) ==="
  docker buildx build --platform linux/amd64 --load -f /tmp/Dockerfile.pvs -t pvs-studio-x86:latest /tmp/
  echo "‚úÖ –û–±—Ä–∞–∑ —Å–æ–±—Ä–∞–Ω –∏ –∑–∞–∫–µ—à–∏—Ä–æ–≤–∞–Ω –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–∏—Ö –∑–∞–ø—É—Å–∫–æ–≤"
else
  echo "‚úÖ –û–±—Ä–∞–∑ pvs-studio-x86:latest —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–±–æ—Ä–∫—É"
fi

echo "=== –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π ==="
mkdir -p ./server/report

echo "=== –ó–∞–ø—É—Å–∫ –∞–Ω–∞–ª–∏–∑–∞ PVS-Studio –≤ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ ==="
# –ò—Å–ø–æ–ª—å–∑—É–µ–º qemu-x86_64 –¥–ª—è —ç–º—É–ª—è—Ü–∏–∏
docker run --rm \
  --platform linux/amd64 \
  -v "$(pwd):/workspace" \
  -w /workspace/server \
  pvs-studio-x86:latest \
  bash -c "
    set +e
    echo '=== –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è PVS-Studio ==='
    if ! command -v pvs-studio-analyzer >/dev/null 2>&1 || pvs-studio-analyzer --version 2>&1 | grep -q 'PVS-Studio –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω'; then
      echo '‚ö†Ô∏è  PVS-Studio –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω (—Å–∞–π—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –∏–∑ –†–æ—Å—Å–∏–∏)'
      echo '‚ö†Ô∏è  –ü—Ä–æ–ø—É—Å–∫–∞–µ–º PVS-Studio, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ cppcheck –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞'
      mkdir -p ./report
      echo '<html><body><h1>PVS-Studio –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω</h1><p>–°–∞–π—Ç pvs-studio.com –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –≤ –†–æ—Å—Å–∏–∏. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ cppcheck –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞.</p></body></html>' > ./report/index.html
      exit 0
    fi
    
    set -e
    echo '=== –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ª–∏—Ü–µ–Ω–∑–∏–∏ PVS-Studio ==='
    pvs-studio-analyzer credentials daniel.kojemyakin@icloud.com Y0G0-6XBZ-2R81-C605 || true
    echo '‚úÖ –õ–∏—Ü–µ–Ω–∑–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∞'
    
    echo '=== –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö —Ñ–∞–π–ª–æ–≤ ==='
    rm -f compile_commands.json moc* Makefile *.o strace_out pvs.log pvs*.tasks
    rm -rf ./report
    
    echo '=== –¢—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏ ==='
    qmake -o Makefile server.pro
    make clean
    pvs-studio-analyzer trace -- make || {
      echo '‚ö†Ô∏è  –¢—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º PVS-Studio'
      mkdir -p ./report
      echo '<html><body><h1>PVS-Studio –∞–Ω–∞–ª–∏–∑ –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω</h1><p>–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–µ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏.</p></body></html>' > ./report/index.html
      exit 0
    }
    
    echo '=== –ó–∞–ø—É—Å–∫ –∞–Ω–∞–ª–∏–∑–∞ PVS-Studio ==='
    mkdir -p ./report
    pvs-studio-analyzer analyze -l /root/.config/PVS-Studio/PVS-Studio.lic -o pvs.log --disableLicenseExpirationCheck || {
      echo '‚ö†Ô∏è  –ê–Ω–∞–ª–∏–∑ –Ω–µ —É–¥–∞–ª—Å—è, —Å–æ–∑–¥–∞–µ–º –ø—É—Å—Ç–æ–π –æ—Ç—á–µ—Ç'
      echo '<html><body><h1>PVS-Studio –∞–Ω–∞–ª–∏–∑ –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω</h1><p>–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ.</p></body></html>' > ./report/index.html
      exit 0
    }
    
    echo '=== –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤ HTML ==='
    plog-converter -a GA:1,2 --renderTypes fullhtml -t tasklist -o ./report/ pvs.log || {
      echo '‚ö†Ô∏è  –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –Ω–µ —É–¥–∞–ª–∞—Å—å'
      exit 0
    }
    
    echo '=== –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ ==='
    if [ -f ./report/pvs.tasks ] || [ -f ./report/index.html ]; then
      echo '‚úÖ HTML –æ—Ç—á–µ—Ç —Å–æ–∑–¥–∞–Ω'
    else
      echo '‚ö†Ô∏è  –û—Ç—á–µ—Ç –Ω–µ —Å–æ–∑–¥–∞–Ω'
      exit 0
    fi
  "

echo "=== –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã ==="
if [ -f ./server/report/pvs.tasks ]; then
  if grep -i 'error' ./server/report/pvs.tasks 2>/dev/null | grep -v 'pvs-studio.com' | grep -v 'Renew' | head -5; then
    echo "‚ö†Ô∏è  –ù–∞–π–¥–µ–Ω—ã –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã (—Å–º. HTML –æ—Ç—á–µ—Ç)"
    echo "–î–ª—è —Å—Ç—Ä–æ–≥–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ 'exit 1' –Ω–∏–∂–µ"
    # exit 1
  fi
fi

echo "‚úÖ PVS-Studio analysis completed successfully"
echo "üìä –û—Ç—á–µ—Ç: server/report/index.html"

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

Artifacts paths:
server/report/** => pvs-studio-report

========================================
–ù–ê–°–¢–†–û–ô–ö–ê REPORT TAB
========================================

Project Settings ‚Üí Report Tabs ‚Üí Create new report tab:

Tab title: PVS-Studio Report
Start page: pvs-studio-report/index.html

========================================
