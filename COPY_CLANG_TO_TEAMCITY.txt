========================================
CLANG STATIC ANALYZER –î–õ–Ø TEAMCITY
========================================

–ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∫–æ–¥–∞ –¥–ª—è C++ (–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ PVS-Studio)
‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ ARM64 –Ω–∞—Ç–∏–≤–Ω–æ
‚úÖ –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∏ –æ—Ç–∫—Ä—ã—Ç—ã–π –∏—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥
‚úÖ –í—Å—Ç—Ä–æ–µ–Ω –≤ Clang

========================================
–®–ê–ì –í TEAMCITY: Clang Static Analyzer
========================================

Runner type: Command Line
Step name: Static Analysis: Clang Static Analyzer (security)
Run: Custom script
Working directory: –ü–£–°–¢–û

Custom script:
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

#!/bin/bash
# –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ —Å –ø–æ–º–æ—â—å—é Clang Static Analyzer

# –£–±–µ–∂–¥–∞–µ–º—Å—è —á—Ç–æ —Å–∫—Ä–∏–ø—Ç –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ bash
if [ -z "$BASH_VERSION" ]; then
  exec /bin/bash "$0" "$@"
fi

set +e

echo "=== –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π ==="
apt-get update -y
apt-get install -y clang clang-tools build-essential qt5-qmake qtbase5-dev cmake

echo "=== –ü–µ—Ä–µ—Ö–æ–¥ –≤ –ø–∞–ø–∫—É —Å–µ—Ä–≤–µ—Ä–∞ ==="
if [ ! -d "./server" ]; then
  echo "‚ùå –ü–∞–ø–∫–∞ server –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!"
  exit 1
fi

cd ./server

echo "=== –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö —Ñ–∞–π–ª–æ–≤ ==="
rm -rf ./report-clang ./clang-analyzer-report
mkdir -p ./report-clang

echo "=== –¢—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏ ==="
qmake -o Makefile server.pro
make clean

echo "=== –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è clang ==="
CLANG_PATH=$(which clang || echo "/usr/bin/clang")
if [ ! -x "$CLANG_PATH" ]; then
  echo "‚ùå clang –Ω–µ –Ω–∞–π–¥–µ–Ω!"
  exit 1
fi
echo "‚úÖ clang –Ω–∞–π–¥–µ–Ω: $CLANG_PATH"

echo "=== –ó–∞–ø—É—Å–∫ Clang Static Analyzer ==="
# –ò—Å–ø–æ–ª—å–∑—É–µ–º scan-build –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
scan-build -o ./report-clang \
  --use-analyzer="$CLANG_PATH" \
  --html-title="Campus Helper - Clang Static Analyzer Report" \
  make 2>&1 | tee clang-analyzer.log

echo "=== –ü–æ–∏—Å–∫ HTML –æ—Ç—á–µ—Ç–∞ ==="
# scan-build —Å–æ–∑–¥–∞–µ—Ç –æ—Ç—á–µ—Ç—ã –≤ –ø–æ–¥–ø–∞–ø–∫–∞—Ö —Å timestamp
REPORT_DIR=$(find ./report-clang -type d -name "report-*" | head -1)

if [ -n "$REPORT_DIR" ] && [ -f "$REPORT_DIR/index.html" ]; then
  echo "‚úÖ HTML –æ—Ç—á–µ—Ç –Ω–∞–π–¥–µ–Ω: $REPORT_DIR"
  # –ö–æ–ø–∏—Ä—É–µ–º –æ—Ç—á–µ—Ç –≤ –∫–æ—Ä–µ–Ω—å report-clang –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞
  cp -r "$REPORT_DIR"/* ./report-clang/ 2>/dev/null || true
  
  # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º
  ISSUES_COUNT=$(grep -c "class=\"issue\"" ./report-clang/index.html 2>/dev/null || echo "0")
  echo "üìä –ù–∞–π–¥–µ–Ω–æ –ø—Ä–æ–±–ª–µ–º: $ISSUES_COUNT"
  
  if [ "$ISSUES_COUNT" -gt 0 ]; then
    echo "‚ö†Ô∏è  –ù–∞–π–¥–µ–Ω—ã –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏/–∫–∞—á–µ—Å—Ç–≤–∞"
    echo "üìÑ –°–º. –æ—Ç—á–µ—Ç: ./report-clang/index.html"
  else
    echo "‚úÖ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º –Ω–µ –Ω–∞–π–¥–µ–Ω–æ"
  fi
else
  echo "‚ö†Ô∏è  HTML –æ—Ç—á–µ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω"
  # –°–æ–∑–¥–∞–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç
  cat > ./report-clang/index.html <<'HTML_END'
<!DOCTYPE html>
<html>
<head><title>Clang Static Analyzer Report</title></head>
<body>
<h1>Clang Static Analyzer Report</h1>
<p>–ê–Ω–∞–ª–∏–∑ –≤—ã–ø–æ–ª–Ω–µ–Ω, –Ω–æ –æ—Ç—á–µ—Ç –Ω–µ –±—ã–ª —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω.</p>
<p>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Å–±–æ—Ä–∫–∏ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π.</p>
</body>
</html>
HTML_END
fi

echo "=== –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ ==="
# –ò—â–µ–º —Ç–∏–ø–∏—á–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –≤ –ª–æ–≥–∞—Ö
if grep -iE "(buffer overflow|use after free|memory leak|null pointer|security)" clang-analyzer.log 2>/dev/null; then
  echo "‚ö†Ô∏è  –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏"
  echo "üìÑ –°–º. –æ—Ç—á–µ—Ç: ./report-clang/index.html"
fi

echo "‚úÖ Clang Static Analyzer analysis completed successfully"

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

Artifacts paths:
server/report-clang/** => clang-analyzer-report

========================================
–ù–ê–°–¢–†–û–ô–ö–ê REPORT TAB
========================================

Project Settings ‚Üí Report Tabs ‚Üí Create new report tab:

Tab title: Clang Static Analyzer Report
Start page: clang-analyzer-report/index.html

========================================
